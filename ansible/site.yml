---
- name: Provision EC2 host (control plane)
  hosts: critchley
  gather_facts: false
  connection: local

  vars:
    aws_scripts_dir: "/home/john/aws"
    webdav_url: "{{ lookup('env','WEBDAV_URL') }}"
    webdav_user: "{{ lookup('env','WEBDAV_USER') }}"
    webdav_password: "{{ lookup('env','WEBDAV_PASSWORD') }}"

  tasks:
    #-jc launch instance
    - name: Launch EC2 instance
      command: >
        {{ aws_scripts_dir }}/awslaunch.py
        {{ inventory_hostname }}
        {{ instance_type }}
      register: launch_result
      changed_when: "'Changed: true' in launch_result.stdout"

    #-jc ensure control ssh directory exists
    - name: Ensure control SSH directory
      file:
        path: "{{ lookup('env','HOME') }}/.ssh"
        state: directory
        mode: "0700"

    #-jc fetch ec2 private key from ssm (retry for eventual consistency)
    - name: Fetch EC2 private key from SSM
      amazon.aws.aws_ssm:
        name: "/critchley/aws/ec2-keypairs/{{ inventory_hostname }}"
        with_decryption: true
      register: ec2_key
      retries: 5
      delay: 3
      until: ec2_key is succeeded

    #-jc install ec2 private key locally
    - name: Install EC2 private key
      copy:
        dest: "{{ lookup('env','HOME') }}/.ssh/{{ inventory_hostname }}.pem"
        content: "{{ ec2_key.parameter.value }}"
        mode: "0600"
      no_log: true

    #-jc query ec2
    - name: Query EC2 for instance info
      amazon.aws.ec2_instance_info:
        filters:
          "tag:Name": "{{ inventory_hostname }}"
          instance-state-name:
            - pending
            - running
            - stopping
            - stopped
      register: ec2_info

    #-jc set facts
    - name: Set instance facts
      set_fact:
        new_instance_id: "{{ ec2_info.instances[0].instance_id }}"
        new_public_ip: "{{ ec2_info.instances[0].public_ip_address }}"
      when: ec2_info.instances | length > 0

    #-jc open ports
    - name: Open UI port
      command: >
        {{ aws_scripts_dir }}/aws_open_port.py
        {{ inventory_hostname }} 8088 any

    - name: Open reporting port
      command: >
        {{ aws_scripts_dir }}/aws_open_port.py
        {{ inventory_hostname }} 8082 any

    #-jc wait for ssh
    - name: Wait for SSH
      wait_for:
        host: "{{ new_public_ip }}"
        port: 22
        timeout: 300

    #-jc scan host key
    - name: Scan SSH host key
      command: ssh-keyscan -T 7 -H {{ new_public_ip }}
      register: ssh_scan
      changed_when: false

    #-jc build hosts fragment
    - name: Build hosts fragment
      copy:
        dest: "/tmp/{{ inventory_hostname }}-latest.hosts"
        content: "{{ new_public_ip }} {{ inventory_hostname }}.critchley.biz {{ inventory_hostname }}"

    #-jc build known_hosts fragment
    - name: Build known_hosts fragment
      copy:
        dest: "/tmp/{{ inventory_hostname }}-latest.known_hosts"
        content: "{{ ssh_scan.stdout }}"

    #-jc upload hosts fragment
    - name: Upload hosts fragment
      command: >
        curl -f
        -u {{ webdav_user }}:{{ webdav_password }}
        -T /tmp/{{ inventory_hostname }}-latest.hosts
        {{ webdav_url }}/{{ inventory_hostname }}-latest.hosts

    #-jc upload known_hosts fragment
    - name: Upload known_hosts fragment
      command: >
        curl -f
        -u {{ webdav_user }}:{{ webdav_password }}
        -T /tmp/{{ inventory_hostname }}-latest.known_hosts
        {{ webdav_url }}/{{ inventory_hostname }}-latest.known_hosts

    #-jc register dynamic host
    - name: Register host for next plays
      add_host:
        name: "{{ inventory_hostname }}"
        ansible_host: "{{ new_public_ip }}"
        groups: deployed

- name: Bootstrap and deploy weather guess stack
  hosts: deployed
  become: true
  become_method: sudo
  become_user: root
  vars:
    app_dir: /opt/python-weather-guess
    model_repo_path: "{{ playbook_dir }}/../src/categorize/model/vgg19-weather.h5"
    model_dir: /models
    model_filename: vgg19-weather.h5
    model_remote_path: "{{ model_dir }}/{{ model_filename }}"

  tasks:
    - name: Set hostname
      hostname:
        name: "{{ inventory_hostname }}"

    #-jc ensure ssh directory exists
    - name: Ensure SSH directory
      file:
        path: "/home/{{ ansible_user }}/.ssh"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0700"

    #-jc find all public keys in repo
    - name: Discover public keys
      delegate_to: localhost
      find:
        paths: "{{ playbook_dir }}/access_keys"
        patterns: "*.pub"
        file_type: file
      register: pubkey_files

    #-jc install authorised ssh keys from repo
    - name: Install authorised SSH keys
      become: false
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ lookup('file', item.path) }}"
      loop: "{{ pubkey_files.files }}"

    #-jc show authorised key fingerprint
    - name: Show installed key
      command: ssh-keygen -lf /home/{{ ansible_user }}/.ssh/authorized_keys
      changed_when: false

    - name: Ensure /models exists on host
      become: true
      file:
        path: "{{ model_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      tags:
        - install_model

    #-jc ensure apt cache fresh
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    #-jc install docker prerequisites
    - name: Install base packages
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    #-jc install docker
    - name: Install docker
      apt:
        name:
          - docker.io
          - docker-compose
        state: present

    #-jc ensure docker running
    - name: Enable and start docker
      service:
        name: docker
        state: started
        enabled: true

    #-jc ensure app directory exists
    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'

    #-jc clone repo
    - name: Checkout application repo
      git:
        repo: https://github.com/john-critchley/python-weather-guess.git
        dest: "{{ app_dir }}"
        version: "{{ inventory_hostname }}"
        update: yes

    - name: Check model file exists
      stat:
        path: "{{ model_repo_path }}"
      delegate_to: localhost
      run_once: true
      register: model_src
      tags:
        - install_model
    
    - name: Push model to host
      become: true
      copy:
        src: "{{ model_repo_path }}"
        dest: "{{ model_remote_path }}"
        mode: "0644"
        force: false
      when: model_src.stat.exists
      tags:
        - install_model

    #-jc pull images
    - name: Pull docker images
      command: docker-compose pull
      args:
        chdir: "{{ app_dir }}"
      changed_when: false

    #-jc build images
    - name: Build docker images
      command: docker-compose build
      args:
        chdir: "{{ app_dir }}"

    #-jc ensure stack running
    - name: Ensure docker compose stack is running
      command: docker-compose up -d --remove-orphans
      args:
        chdir: "{{ app_dir }}"
    
- name: Checks after system is provisioned
  gather_facts: false
  connection: local
  hosts: localhost

  tasks:
       - name: Check reporting stats externally
         uri:
           url: "http://{{new_public_ip}}:8082/stats"
           return_content: true
         register: stats_ext
         retries: 60
         delay: 2
         until:
           - stats_ext.status == 200
           - "'\"status\": \"ok\"' in stats_ext.content"
         tags: system_tests
   
       - name: Check UI externally
         uri:
           url: "http://{{new_public_ip}}:8088/"
           status_code: 200
         register: ui_ext
         retries: 30
         delay: 2
         until: ui_ext.status == 200
         tags: system_tests
